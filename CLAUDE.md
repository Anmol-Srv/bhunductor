# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## What This Is

Bhunductor is an Electron desktop app that wraps the Claude CLI with a visual UI. Users open git repositories, manage branches via worktrees, and interact with Claude through a chat interface. The app spawns Claude CLI as a subprocess and streams its NDJSON output to a React frontend.

## Build & Development Commands

```bash
npm start              # Build + launch Electron app
npm run devi           # Dev mode: webpack watch + electronmon (hot reload)
npm run build          # Production webpack build (renderer only)
npm run watch          # Webpack watch only (no Electron)
npm run pack           # electron-builder --dir (unpacked)
npm run dist           # electron-builder (distributable)
npm run postinstall    # electron-rebuild (native modules)
```

There are no tests or linting configured yet.

## Architecture Overview

### Process Model

```
Electron Main Process (Node.js)
├── IPC Handlers (main/ipc-handlers.js) ← single file, all 49 channels
├── SQLite Database (better-sqlite3, synchronous)
├── ClaudeSessionManager → spawns ClaudeProcess subprocesses
└── PermissionHttpServer (Fastify) ← receives MCP permission requests

Renderer Process (React, no router)
├── App.js manages navigation state (currentPage, selectedFolder)
├── Pages: Home (repo picker), Dashboard (worktree + chat)
└── ClaudeChat.js ← main chat component with message cache

Claude CLI Subprocess (per session)
├── Spawned with: --print --input-format stream-json --output-format stream-json
├── Outputs NDJSON events: system, assistant, content_block_*, message_*, result, error
└── MCP config written to /tmp/mcp-config-{sessionId}.json per session
```

### IPC Communication

All IPC channels are defined in `shared/constants.js` and allowlisted in `renderer/preload.js`. The context bridge exposes `window.electron.invoke()` (request-response) and `window.electron.on()` (events).

Channel naming convention: `{domain}:{action}` (e.g., `claude:session-start`, `worktree:create`, `file:tree-get`).

IPC handlers return `{ success: true, ...data }` or `{ success: false, error: string }`.

### Claude CLI Integration

**Two IDs per session:** Internal `sessionId` (UUID v4, generated by app) and `claude_session_id` (assigned by CLI, stored in DB for `--resume`).

**Stream event pipeline:** ClaudeProcess buffers stdout, splits on newlines, parses JSON events:
- `content_block_delta` → streams text/thinking/tool_input chunks via IPC
- `content_block_stop` → finalizes tool_use blocks
- `message_stop` → signals end of assistant turn
- `result` → cost/usage data forwarded as `claude:turn-complete`
- `assistant` event is a fallback — skipped if `content_block_delta` events already arrived (`hasStreamedContent` flag)
- `forwardedToolUseIds` Set prevents duplicate tool_use events from both streaming and assistant events

**MCP permission flow:** Claude CLI → MCP server subprocess (stdio) → HTTP POST to PermissionHttpServer → IPC to renderer → PermissionPrompt UI → user approves/denies → response flows back. 5-minute timeout on pending permissions.

**Permission state limitation:** Pending permissions are ephemeral (stored in-memory only). On app restart, `--resume` flag is NOT used when reactivating sessions to prevent hanging on stale permissions. Sessions use `--session-id` instead, which continues the conversation from stored messages without resuming pending CLI state.

**MCP session naming:** The MCP server provides a `rename_session` tool that Claude uses to name sessions. Custom system prompt injected via `--append-system-prompt` flag instructs Claude to rename the session after the first user message. This enables agent-driven session naming instead of automatic first-message extraction. The `rename_session` tool is auto-approved (no permission prompt) and hidden from chat UI (filtered in SessionService callbacks).

### Data Layer

SQLite via better-sqlite3 (all operations synchronous). Models are static utility classes (`Folder`, `Worktree`, `File`) that call `getDatabase()` singleton.

Key tables: `folders` (repositories), `worktrees` (branches), `claude_sessions` (sessions with messages JSON, archived flag, claude_session_id).

Migrations run automatically on startup in `database.js`. Currently 8 migrations.

### Renderer State Management

Plain React useState in Dashboard.js — no state library:
- `sessionsByWorktree` — map of worktreeId → session arrays
- `openTabs` / `activeTabId` — multi-tab session UI
- `messageCache` — **module-level** Map in ClaudeChat.js (survives unmount/remount on tab switch)
- Lazy resume: shows previous session read-only with "Resume" button, pre-seeds message cache

## Non-Obvious Conventions

- `worktree_path` is NULL for the main branch (`is_main = 1`). Always use `Worktree.getActivePath(worktree, folder)` to resolve the correct filesystem path.
- All console logging uses component prefixes: `[Main]`, `[IPC]`, `[Database]`, `[Claude CLI]`, `[ClaudeChat]`, etc.
- Git operations use `execSync()` with `cwd` option throughout the models.
- Model picker is locked after first message — CLI sets model at spawn time via `--model` flag.
- Sessions are soft-deleted (archived flag) rather than hard-deleted from the database.
- File tree traversal is capped at depth 5 and excludes `.git`, `node_modules`, `.bhunductor`.
- The MCP permission server port is OS-assigned (dynamic), not hardcoded.
- User MCP servers from `.mcp.json` and `~/.claude.json` are merged into the per-session MCP config.
- Session naming is handled by Claude via the `rename_session` MCP tool, guided by custom instructions. Automatic title extraction from first message is disabled.

## App Data Locations (macOS)

- Database + config: `~/.bhunductor/` (`workspaces.db`, `config.json`)
- Worktrees: `{repository}/.bhunductor/worktrees/{branch-name}/`
- Temp MCP configs: `/tmp/mcp-config-{sessionId}.json` (cleaned up on exit)
